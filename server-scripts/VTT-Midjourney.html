<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
<title>VTT Midjourney</title>
<link rel="shortcut icon" href="https://www.midjourney.com/favicon.ico">
<base href="http://212.47.248.129:8172/">
<div id=input class=row>
  <div id=fullPrompt class=row>
    <input placeholder=Prefix>
    <input id=term placeholder=Prompt>
    <input placeholder=Suffix>
  </div>
  <div class="row staticWidth">
    <select></select>
    <button>Go!</button>
  </div>
</div>
<div id=queueSection class="collapsible collapse empty">
  <h2 id=queueHeader>Queue (<span id="queued">0</span> waiting / <span id="sent">0</span> sent)</h2>
  <ol id=queue reversed></ol>
</div>
<div id=errorSection class="collapsible collapse empty">
  <h2 id=errorHeader>Errors (<span id="errors">0</span> errors / <span id="timeout">0</span> timed out)</h2>
  <ul id=errorList></ul>
</div>
<div id=search class=row> 
  <h2>Completed Jobs</h2>
    <div class="row staticWidth">
      <div class="staticWidth"><input type=checkbox id=allThreads checked><label for=allThreads> All threads</label></div>
      <div class="staticWidth"><input type=checkbox id=upscale checked><label for=upscale> Upscales</label></div>
      <div class="staticWidth"><input type=checkbox id=grid checked><label for=grid> Girds</label></div>
    </div>
    <select><option>10</option><option>50</option><option>250</option><option>1000</option><option>5000</option></select>
    <input id=filter placeholder=Filter>
</div>
<div id=list></div>
<button id=reload>Reload all results</button>
<style>
  :root {
    background-color: #333;
    color: #999;
  }
  *, #list {
    margin: 0;
    padding: 0;
  }
  body > * {
    margin: .5rem;
  }
  li {
    margin-left: 2rem;
  }
  h2 {
    min-width: 10em;
    flex-grow: 0;
  }
  .row {
    display: flex;
    flex-flow: row wrap;
    gap: .5rem;
    align-items: baseline;
  }
  .row > * {
    flex-grow: 1;
  }
  .row > .staticWidth, .row > select, .row > button {
    flex-grow: 0;
  }
  #fullPrompt {
    gap: 0;
    min-width: 36rem;
  }
  #fullPromt > *, #filter {
    flex-basis: 12rem;
  }
  #term {
    flex-grow: 5;
  }
  #queueSection.empty,
  #queueSection.collapse #queue,
  #errorSection.empty,
  #errorSection.collapse #errorList {
    display: none;
  }
  .collapsible h2 {
    font-size: 1.2rem;
  }
  .collapsible h2::after {
    font-size: .8rem;
    content: " [click to hide]"
  }
  .collapse h2::after {
    content: " [click to show]"
  }
  li.error {
    background-color: #600;
  }
  li.timeout {
    color: #666;
  }
  li.sent {
    color: #090;
  }
  .images {
    display:flex;
    flex-flow: row wrap;
    justify-content: center;
    alighn-items: center;
  }
  .image {
    position: relative;
    min-width: 15vmin;
    min-height: 15vmin;
  }
  .image a {
    display: block;
  }
  img {
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100vh;
    display: block;
  }
  .image .buttons {
    position: absolute;
    bottom: 1vmin;
    right: 1vmin;
  }
  .image .buttons button {
    font-size: 4vmin;
    height: 5vmin;
    width: 5vmin;
    opacity: 0.5;
  }
  .image .buttons button.pressed {
    opacity: 1;
  }
  #list p {
    color: #000;
    margin: .5rem 0;
    padding: .5rem;
    background-color: #666;
  }
  .images-2 .image {
    max-width: 50%;
  }
  .images-4 .image {
    max-width: 25%;
  }
  @media (max-width:60rem) {
    #fullPrompt {
      min-width: 100%;
    }
  }
  @media (max-width:37rem) {
    #fullPrompt {
      flex-flow: column;
    }
    #fullPrompt > * {
      width: 100%;
    }
  }
  @media (max-width:767px) {
    /* default image size is 256x256. Switches to 2x2 display when too narrow for 3 across. */
    .images-4 .image {
      max-width: 50%;
    }
    .images-4 img {
      max-height: 50vh;
    }
  }
</style>
<script>
  let jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
  let threads = JSON.parse(localStorage.getItem('threads') || '[]');
  let queue = [];

  function $(selector, parent) {
    return (parent || document).querySelector(selector);
  }

  function $a(selector, parent) {
    return (parent || document).querySelectorAll(selector);
  }

  async function fetchJobs(all=false) {
    let data = null;
    if(all)
      data = { jobs: await (await fetch(`/jobs`)).json() };
    else
      data = await (await fetch(`/jobs/${jobs.length ? jobs[0].t : 0}`)).json();

    if(data.jobs.length) {
      let newJobs = 0;
      for(const job of data.jobs) {
        if(!jobs.filter(j=>j.i==job.i).length) {
          jobs.push(job);
          ++newJobs;
        }
      }
      if(newJobs) {
        jobs.sort((a,b)=>+new Date(b.t) - +new Date(a.t));
        updateImageList();
        localStorage.setItem('jobs', JSON.stringify(jobs));
      }
    }
    if(!all) {
      queue = data.queue;
      queue.sort((a,b)=>+new Date(b.timeAdded) - +new Date(a.timeAdded));
      updateQueue();
    }
  }

  async function fetchThreads() {
    let newThreads = 0;
    (await (await fetch(`/threads`)).json()).threads.forEach(t=>{
      if(threads.filter(_=>_.id==t.id).length==0) {
        threads.push({id:t.id,name:t.name});
        newThreads ++;
      }
    });
    if(newThreads) {
      threads.sort((a,b)=>a.name.localeCompare(b.name));
      updateThreads();
      updateImageList();
      updateQueue();
      localStorage.setItem('threads', JSON.stringify(threads));
    }
  }

  function updateQueue() {
    let counts = {queued:0,sent:0,timeout:0,error:0};
    $('#queue').innerHTML = '';
    $('#errorList').innerHTML = '';
    for(const entry of queue.sort((a,b)=>b.timeAdded-a.timeAdded)) {
      const entryDOM = document.createElement('li');
      entryDOM.className = entry.status;
      const references = jobs.filter(j=>j.i==entry.reference);
      const threadID = entry.func == 'imagine' ? entry.params[0] : (references.length ? references[0].x : null);
      entryDOM.innerHTML = threads.filter(t=>t.id==threadID).reduce((_,t)=>'<span class=thread>'+t.name+':</span> ', '');
      entryDOM.innerHTML += entry.func == 'imagine' ? entry.params[1] : (references.length ? references[0].c : '<reference not found>') + " -- " + entry.params[0];
      entryDOM.innerHTML += ` (${entry.status}${entry.result ? ' -- '+entry.result : ''})`;
      if(counts.hasOwnProperty(entry.status)) {
        counts[entry.status] += 1;
      } else {
        counts.error += 1;
      }
      switch(entry.status) {
      case 'queued':
      case 'sent':
        $('#queue').append(entryDOM);
        break;
      default:
        $('#errorList').append(entryDOM);
      }
    }
    $('#queued').innerHTML = counts.queued;
    $('#sent').innerHTML = counts.sent;
    $('#timeout').innerHTML = counts.timeout;
    $('#errors').innerHTML = counts.error;
    if(counts.queued + counts.sent) {
      $('#queueSection').classList.remove('empty')
    } else {
      $('#queueSection').classList.add('empty')
    }
    if(counts.error + counts.timeout) {
      $('#errorSection').classList.remove('empty')
    } else {
      $('#errorSection').classList.add('empty')
    }
  }

  function updateImageList() {
    $('#list').innerHTML = '';

    const filter = new RegExp($('#filter').value, 'i');
    const thread = $('#input select').value;
    const all = $('#allThreads').checked;
    const up = $('#upscale').checked;
    const grid = $('#grid').checked;
    const count = $('#search select').value;

    for(const job of jobs.filter(j=>(j.c||'').match(filter) && (all || j.x==thread) && (j.g ? grid : up)).slice(0, count)) {
      const threadName = threads.filter(t=>t.id==job.x).reduce((_,t)=>t.name, '');
      const jobDOM = document.createElement('div');
      jobDOM.className = `job${job.g ? ' grid' : ''}`;
      jobDOM.id = job.i;
      jobDOM.innerHTML = `<p>${threadName?'<span>'+threadName+':<span> ':''}</p>`;
        $('p', jobDOM).append(job.c);
      if(job.g)
        $('p', jobDOM).innerHTML += ` <button data-command="reroll::0::SOLO">R</button>`
      const imagesDOM = document.createElement('div');
      imagesDOM.className = `images images-${job.n}`;
      for(let i=0; i<job.n; ++i) {
        const imageDOM = document.createElement('div');
        const url = `https://storage.googleapis.com/dream-machines-output/${job.i}/0_${i}.png`;
        imageDOM.innerHTML = `<a href="${url}"><img src="${url}"></a>`
        imageDOM.className = 'image';

        if(job.g) {
          imageDOM.innerHTML += `
            <div class=buttons>
              <button data-command="variation::${+i+1}">V</button>
              <button data-command="upsample::${+i+1}">U</button>
            </div>
          `;
        } else {
          imageDOM.innerHTML += `<div class=buttons></div>`;
          if(!job.c.match(/--up/)) {
            $('.buttons', imageDOM).innerHTML += `<button data-command="upsample_light::1::SOLO">L</button>`;
            $('.buttons', imageDOM).innerHTML += `<button data-command="upsample_beta::1::SOLO">B</button>`;
            $('.buttons', imageDOM).innerHTML += `<button data-command="remaster::1::SOLO">R</button>`;
          }
          $('.buttons', imageDOM).innerHTML += `<button data-command="variation::1::SOLO">V</button>`;
        }

        imagesDOM.appendChild(imageDOM);
      }
      jobDOM.appendChild(imagesDOM);

      for(const button of $a('button', jobDOM)) {
        button.onclick = function() {
          fetch(`/button/${encodeURIComponent(button.dataset.command)}/${job.i}`);
          button.classList.add('pressed');
          fetchJobs();
        };
      }

      $('#list').appendChild(jobDOM);
    }
  }

  async function updateThreads() {
    const selected = localStorage.getItem('channel') || '1019305731196997743';
    $('#input select').innerHTML = '';
    for(const thread of threads)
      $('#input select').innerHTML += `<option value=${thread.id} ${thread.id == selected ? 'selected' : ''}>${thread.name}</option>`;
  }

  function updatePresets() {
    const thread = $('#input select').value;
    $('[placeholder=Prefix]').value = localStorage.getItem('prefix'+thread) || localStorage.getItem('prefix');
    $('[placeholder=Suffix]').value = localStorage.getItem('suffix'+thread) || localStorage.getItem('suffix');
  }

  window.onload = function() {
    if(threads.length)
      updateThreads();

    if(jobs.length)
      updateImageList();
    else
      setTimeout(_=>fetchJobs(true), 100);

    fetchThreads();
    fetchJobs();

    updatePresets();
  };

  setInterval(fetchJobs, 5000);

  $('#input button').onclick = function() {
    const thread = $('#input select').value;
    const prefix = $('[placeholder=Prefix]').value;
    const suffix = $('[placeholder=Suffix]').value;
    localStorage.setItem('prefix', prefix);
    localStorage.setItem('prefix'+thread, prefix);
    localStorage.setItem('suffix', suffix);
    localStorage.setItem('suffix'+thread, suffix);
    localStorage.setItem('channel', thread);
    const prompt = prefix + ' ' + $('#term').value + ' ' + suffix;
    const banned = prompt.match(/\b(🍆|🍑|🤢|😏|adult actress|adult industry|adult movie|ahegao|amniotic sack|amoruos|areola|arse|Asa Akira|ass|badonkers|ball gag|bare chest|bare midriff|bare woman|bastard|bawdy|bbw|bdsm|beheaded|belle delphine|belly button|between her legs|big black|blister|blood|blow job|blumpkin|Bob's|body horror|bodypaint|bondage|boobs|booty|bosom|boudoir|Braless|breast|breasted|breastfeeding|Breasts|breeding|brothel|bum|busty|butt|buxom|cadaver|cannibal|car crash|chairman mao|cheeks|chest press|chest pressed|chesty|cleavage|clunge|cocaine|cock|coitus|completely exposed|condom|coon|corpsez|cp|crap|creampie|cronenberg|crucified|crucifixion|cuckold|cum|cut|cutting|darfing|deepfake|dick|dildo|disturbing|dobonhonkeros|doggy style|domination|dominatrix|down Syndrome|dyke|e621|erotic|escort|Eva Elfie|executionsy|exhibitionism|exposed chest|fanny|fart|farts|fascist|feasting|femal body|female body|femboy|fetish|fetus|Fingering|firently|firingid|flesh|fleshy|Fuck|fucking|full frontal|futanari|g-string|gabbie carter|garrot|girentry|girth|girthy|goatse|gore|gory|gr|gravure idol|gruesome|guro|guts|gypsy|gyroy|harem|harlot|Hegre Art|heilx|heroin|Hitler|holocaust|homo|honkers|Hooker|hot chick|hot girl|human centipede|human skin|humping|in the shower|inapporpriate|inappropriate|incest|infected|infection|infested|intercourse|internal organs|Invisible Clothes|jav|jerk off|Jinping|jirently|kill|killing|killings|kinbaku|kinky|knob|knockers|labia|laced|Lana Rhoades|large chest|legs spread|lemon party|lena paul|lewd|libidinous|Licentious|lingerie|Lolita|lovemaking|lust|lusty|maggots|making love|mammaries|massacre|mating|meth|micro bikini|microbikini|microkini|milf|milkers|minge|mommy milker|mucus|naked|nasty|naturist|naughty|nazi|negligee|nig nog|nigger|nipple|No cloth|no clothes|no shirt|nubile|nude|nudity|nutsack|nuude|onlyfans|oppai|organs|orgasmic|page 3|panties|parasite|parasites|pecker|pene|penetration|penis|perky|petite|phallus|pidor пидарас, пидарасина|pinup|piss|plane crash|pleasure|pleasures|pole dancing|poon|poop|porn|preteen|prick|Prophet Mohammed|prostitute|provocative|pubic|puking|pus|puss|pussy|queef|rape|rated x|rectum|reproduce|reproductive|reticulum|ribald|rimming|risqué|round chest|rule34|sadism|sadist|sadistic|salacious|Sasha Grey|scantily clad|schlong|scrotum|seducing|seductive|semen|sensual|sex|sexy|shag|shemale|shibari|shirtless|shit|shitty|showering|skank|skimpy|skinless|skinny dipping|slaughter|slave|spanking|spic|splooge|Strip Pole|stripped|succubus|suggestive|sultry|surgery|swinger|Tainted Love|take off clothes|takes of her underwear|takes of his underwear|taking a shower|tearing|teratoma|testicles|thicc|thirst trap|thong|thot|threesome|tiddy|tiddies|Tied Up|tig ol biddies|tit|tits|titillating|titty|titties|tittays|torture|transparent clothes|trap|tresherous|tresherousy|trypophobia|turd|tush|twerk|twerks|twerking|twink|twitter|unclad|unclothed|uncouth|underboob|underwear|Undies|Undies Off|undress|undressing|UTI|vaccine|vagina|vein|veiny|venereal|vile|viscera|visceral|vivisection|voluptuous|vomit|vore|wang|wank|wart|warty|waygert|wearing invisible|wearing nothing|well endowed|wet t-shirt|wetback|whore|whorehouse|wiener|willy|wincest|with no shirt|without anything|wound|x-rated|xxx|Yaoi|Yuri|Zedong|Zero clothes)\b/i);
    if(banned) {
      alert(`The word "${banned[0]}" is banned.`);
    } else {
      fetch(`/imagine/${encodeURIComponent($('#input select').value)}/${encodeURIComponent(prompt.trim())}`);
      $('#term').value = '';
      fetchJobs();
    }
  }
  $('#term').onkeydown = function(e) {
    if(e.keyCode == 13)
      $('#input button').click();
  }
  $('#filter').onkeyup = updateImageList;
  $a('select, [type=checkbox]').forEach(_=>_.addEventListener('change', updateImageList));
  $('#input select').addEventListener('change', updatePresets);

  $('#reload').onclick = function() {
    jobs = [];
    fetchJobs(true);
  };
  $('#queueHeader').onclick = _=>$('#queueSection').classList.toggle('collapse');
  $('#errorHeader').onclick = _=>$('#errorSection').classList.toggle('collapse');
</script>
